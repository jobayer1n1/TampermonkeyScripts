// ==UserScript==
// @name         NSU Grade Analysis Dashboard (Movable & Minimizable)
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Display grade distribution and CGPA calculation (Draggable & Collapsible)
// @author       Jobayer
// @match        https://rds3.northsouth.edu/students/courseAnalysis/viewAnalysis*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    console.log('NSU Grade Dashboard script loaded');

    // --- 1. Analysis Logic---
    function analyzeGrades() {
        const gradeCount = {};
        let stats = {
            regular: { creditsPassed: 0, gradePoints: 0, cgpa: 0 },
            total: { creditsPassed: 0, gradePoints: 0, cgpa: 0 },
            courseCount: 0
        };

        const allTables = document.querySelectorAll('table.table-bordered');

        allTables.forEach((table) => {
            let isNonCreditSection = false;
            let isWaiverSection = false;

            // Check section headers
            let container = table.closest('.table-responsive') || table;
            let sibling = container.previousElementSibling;
            let attempts = 0;
            while (sibling && attempts < 5) {
                if (sibling.tagName === 'H3') {
                    const headerText = sibling.textContent.trim().toLowerCase();
                    if (headerText.includes('non credit courses')) isNonCreditSection = true;
                    else if (headerText.includes('waiver')) isWaiverSection = true;
                    break;
                }
                sibling = sibling.previousElementSibling;
                attempts++;
            }

            if (isWaiverSection) return;

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach((row) => {
                if (row.querySelector('th')) return;
                const cells = row.querySelectorAll('td');
                if (cells.length < 7) return;

                const grade = cells[3].textContent.trim();
                const gradePoints = parseFloat(cells[4].textContent.trim());
                const creditPassed = parseFloat(cells[6].textContent.trim());

                if (grade && grade !== '' && grade !== '&nbsp;') {
                    gradeCount[grade] = (gradeCount[grade] || 0) + 1;
                    stats.courseCount++;

                    if (!isNaN(creditPassed) && !isNaN(gradePoints)) {
                        stats.total.creditsPassed += creditPassed;
                        stats.total.gradePoints += gradePoints;
                        if (!isNonCreditSection) {
                            stats.regular.creditsPassed += creditPassed;
                            stats.regular.gradePoints += gradePoints;
                        }
                    }
                }
            });
        });

        if (stats.regular.creditsPassed > 0) stats.regular.cgpa = (stats.regular.gradePoints / stats.regular.creditsPassed).toFixed(2);
        if (stats.total.creditsPassed > 0) stats.total.cgpa = (stats.total.gradePoints / stats.total.creditsPassed).toFixed(2);

        stats.regular.creditsPassed = stats.regular.creditsPassed.toFixed(1);
        stats.total.creditsPassed = stats.total.creditsPassed.toFixed(1);

        return { gradeCount, stats };
    }

    // --- 2. Draggable Logic Helper ---
    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // Get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // Call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // Calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // Set the element's new position:
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
            // Remove 'right' and 'bottom' constraints if they exist so 'top/left' takes precedence
            element.style.right = 'auto';
            element.style.bottom = 'auto';
        }

        function closeDragElement() {
            // Stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // --- 3. UI Creation ---
    function createDashboard(data) {
        const existingDashboard = document.getElementById('grade-dashboard');
        if (existingDashboard) existingDashboard.remove();

        const { gradeCount, stats } = data;

        // Build Grade HTML
        const gradeOrder = ['A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'F'];
        let gradeHTML = '';
        gradeOrder.forEach(g => {
            if(gradeCount[g]) gradeHTML += `<div class="grade-item"><span class="grade-label">${g}</span><span class="grade-value">${gradeCount[g]}</span></div>`;
        });
        Object.keys(gradeCount).forEach(g => {
            if(!gradeOrder.includes(g)) gradeHTML += `<div class="grade-item"><span class="grade-label">${g}</span><span class="grade-value">${gradeCount[g]}</span></div>`;
        });

        const dashboard = document.createElement('div');
        dashboard.id = 'grade-dashboard';
        dashboard.innerHTML = `
            <style>
                #grade-dashboard {
                    position: fixed;
                    top: 80px;
                    right: 20px; /* Initial position */
                    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                    color: white;
                    padding: 0; /* Padding moved to inner containers for minimize effect */
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
                    z-index: 10000;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    width: 300px;
                    overflow: hidden; /* Important for minimize transition */
                    transition: height 0.3s ease;
                }

                /* Drag Handle (Header) */
                #grade-dashboard-header {
                    padding: 12px 15px;
                    cursor: move; /* Move cursor */
                    background: rgba(0,0,0,0.1);
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                #grade-dashboard-header h2 {
                    margin: 0;
                    font-size: 16px;
                    font-weight: 600;
                    pointer-events: none; /* Let clicks pass through to handle */
                }

                .dashboard-content {
                    padding: 15px;
                    max-height: 80vh;
                    overflow-y: auto;
                }

                /* Scrollbar styling */
                .dashboard-content::-webkit-scrollbar { width: 6px; }
                .dashboard-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }

                /* Minimized State */
                #grade-dashboard.minimized .dashboard-content {
                    display: none;
                }
                #grade-dashboard.minimized {
                    width: 200px; /* Smaller width when minimized */
                }

                /* Buttons */
                .ctrl-btn-group {
                    display: flex;
                    gap: 8px;
                }
                .ctrl-btn {
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    line-height: 1;
                    transition: background 0.2s;
                }
                .ctrl-btn:hover { background: rgba(255,255,255,0.4); }
                .close-btn:hover { background: #ff4444; }

                /* Data Styling */
                .dashboard-section {
                    background: rgba(255,255,255,0.15);
                    padding: 10px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    backdrop-filter: blur(10px);
                }
                .dashboard-section h3 {
                    margin: 0 0 8px 0;
                    font-size: 13px;
                    font-weight: 600;
                    color: #e0e0e0;
                    text-transform: uppercase;
                }
                .grade-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
                .grade-item { background: rgba(255,255,255,0.2); padding: 4px; border-radius: 4px; text-align: center; }
                .grade-label { font-weight: 600; font-size: 11px; display: block; color: #ccc; }
                .grade-value { font-size: 14px; font-weight: 700; display: block; }

                .cgpa-box-full {
                    background: rgba(255,255,255,0.2);
                    padding: 10px;
                    border-radius: 6px;
                    text-align: center;
                    margin-bottom: 8px;
                    border-left: 4px solid #4CAF50;
                }
                .cgpa-box-full.secondary { border-left: 4px solid #FFC107; }
                .cgpa-label { font-size: 12px; opacity: 0.9; display: block; margin-bottom: 2px; }
                .cgpa-value { font-size: 24px; font-weight: 700; display: block; }
                .cgpa-sub { font-size: 11px; opacity: 0.7; }
            </style>

            <div id="grade-dashboard-header">
                <h2>ðŸ“Š Grade Analysis Extra</h2>
                <div class="ctrl-btn-group">
                    <button class="ctrl-btn" id="minimize-dashboard" title="Minimize">-</button>
                    <button class="ctrl-btn close-btn" id="close-dashboard" title="Close">Ã—</button>
                </div>
            </div>

            <div class="dashboard-content">
                <div class="dashboard-section">
                    <h3>Academic Summary</h3>
                    <div class="cgpa-box-full">
                        <span class="cgpa-label">CGPA (without Non-Credits)</span>
                        <span class="cgpa-value">${stats.regular.cgpa}</span>
                        <span class="cgpa-sub">Passed Credits: ${stats.regular.creditsPassed}</span>
                    </div>
                    <div class="cgpa-box-full secondary">
                        <span class="cgpa-label">CGPA (Including Non-Credits)</span>
                        <span class="cgpa-value">${stats.total.cgpa}</span>
                        <span class="cgpa-sub">Passed Credits: ${stats.total.creditsPassed}</span>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h3>Grade Distribution</h3>
                    <div class="grade-grid">
                        ${gradeHTML}
                    </div>
                    <div style="text-align:center; margin-top:5px; font-size:11px;">
                        Total Courses: ${stats.courseCount}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(dashboard);

        // --- Activate Features ---

        // 1. Close Button
        document.getElementById('close-dashboard').addEventListener('click', function() {
            dashboard.style.display = 'none';
        });

        // 2. Minimize Button
        const minimizeBtn = document.getElementById('minimize-dashboard');
        minimizeBtn.addEventListener('click', function() {
            dashboard.classList.toggle('minimized');
            if(dashboard.classList.contains('minimized')){
                minimizeBtn.textContent = 'â—»'; // Change to plus sign
                minimizeBtn.title = "Expand";
            } else {
                minimizeBtn.textContent = '-'; // Change back to minus
                minimizeBtn.title = "Minimize";
            }
        });

        // 3. Make Draggable (Target the header element)
        const header = document.getElementById('grade-dashboard-header');
        makeDraggable(dashboard, header);
    }

    // Initialization
    function init() {
        const tables = document.querySelectorAll('table.table-bordered');
        if (tables.length > 0) {
            const analysisData = analyzeGrades();
            createDashboard(analysisData);
        } else {
            setTimeout(init, 500);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        setTimeout(init, 500);
    }

})();
